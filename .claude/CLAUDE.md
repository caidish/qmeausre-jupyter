# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## General Guidelines
- **Always use conda environment instrMCPdev for testing** by `source ~/miniforge3/etc/profile.d/conda.sh && conda activate instrMCPdev`
- Whenever you need to confirm API of measureit(qmeasure), test it in the conda environment.
- Use context7 for code references, especially for measureit(qmeasure)
- We will use measureit: https://github.com/nanophys/MeasureIt/
- check requirements.txt when new python file is created.
- update pyproject.toml
- when removing features, update readme.md
- Format code when wrapping up: `black`. Check linter.

## About MeasureIt/QMeasure
Here is a note for the agent, based on the `MeasureIt` library and the `instrMCP` templating pattern.

-----

### ðŸ¤– Agent Briefing: Generating `MeasureIt` Sweep Code

Your primary task is to **generate executable Python code strings** for the `MeasureIt` library. You will receive structured parameters (as a dictionary or JSON) from the GUI and must convert this data into a valid, human-readable Python script.

### 1\. Core `MeasureIt` Concepts

  * **Purpose:** `MeasureIt` is a `qcodes`-based Python library for running physics experiments.
  * **Core Classes:** The main classes you will generate code for are `Sweep0D`, `Sweep1D`, and `Sweep2D`.
  * **Basic Pattern:**
    1.  **Import:** `from measureit import Sweep1D` (and `qcodes as qc`).
    2.  **Get `station`:** `station = qc.Station.default` (or a specific one).
    3.  **Get `set_param`:** The parameter to sweep is retrieved from the `station` (e.g., `set_param = station.magnet.field`).
    4.  **Instantiate:** `sweep = Sweep1D(set_param=set_param, start=0, stop=1, step=0.1, ...)`
    5.  **Configure:** Add "follow" parameters (e.g., `sweep.follow_param(station.dmm.voltage)`).
    6.  **Run:** `sweep.start()`

### 2\. The Generation Task: Data-to-Code

You are not just dumping variables into a template. You must **pre-process** the input parameters into correctly formatted Python code *snippets* first, and then inject those snippets into a main template.

The `instrMCP` reference shows this "two-step" pattern.

#### Rule 1: Use f-string "Skeletons"

Define the base templates for `Sweep0D`, `Sweep1D`, and `Sweep2D`.

**Example `Sweep1D` Template:**

```python
# Generated by AI Agent
from measureit import Sweep1D
import qcodes as qc

# Get station and parameter
station = qc.Station.default
set_param = station.{set_param_name}

# Initialize sweep
sweep = Sweep1D(
    set_param=set_param,
    start={start},
    stop={stop},
    {step_or_count_str},
    {bidirectional_str},
    plot_data=True,
    save_data=True
)

# Add parameters to follow
{follow_params_str}

# Start sweep
print("Starting 1D sweep...")
sweep.start()
print("Sweep finished.")
```

#### Rule 2: Pre-Process Inputs (The Critical Step)

Your main logic is to transform the input `params` dict into the replacement values for the template (e.g., `{follow_params_str}`).

**Example Input `params`:**

```json
{
  "sweep_type": "1D",
  "set_param": "magnet.field",
  "start": 0,
  "stop": 5,
  "step": 0.1,
  "bidirectional": true,
  "follow_params": ["dmm.voltage", "lockin.X"]
}
```

**Your Pre-Processing Logic:**

1.  **Simple Values:**

      * `set_param_name = params['set_param']` (e.g., `"magnet.field"`)
      * `start = params['start']` (e.g., `0`)
      * `stop = params['stop']` (e.g., `5`)

2.  **Conditional/Calculated Logic (Step):** Handle `step` vs. `step_count`.

    ```python
    if 'step' in params:
        step_or_count_str = f"step={params['step']}"
    elif 'step_count' in params:
        step_or_count_str = f"step_count={params['step_count']}"
    else:
        step_or_count_str = "# ERROR: No step or step_count provided"
    ```

3.  **Conditional/Boolean Logic (Bidirectional):** Do not add `bidirectional=False`. Only add the flag if `True`.

    ```python
    if params.get('bidirectional', False):
        bidirectional_str = "bidirectional=True"
    else:
        bidirectional_str = "" # Omit the line
    ```

4.  **List-to-Code Conversion (Most Important):** This is the key. You must convert a *list of strings* into a *multi-line block of Python code*.

    ```python
    follow_list = params.get('follow_params', [])
    if not follow_list:
        follow_params_str = "# No parameters followed"
    else:
        # Note: We assume all params are properties of 'station'
        lines = [f"sweep.follow_param(station.{p})" for p in follow_list]
        follow_params_str = "\n".join(lines)
    ```

### 3\. Final Assembled Code (Output)

After running this logic, you will format the main template. The result for the example input above would be this **final string**:

```python
# Generated by AI Agent
from measureit import Sweep1D
import qcodes as qc

# Get station and parameter
station = qc.Station.default
set_param = station.magnet.field

# Initialize sweep
sweep = Sweep1D(
    set_param=set_param,
    start=0,
    stop=5,
    step=0.1,
    bidirectional=True,
    plot_data=True,
    save_data=True
)

# Add parameters to follow
sweep.follow_param(station.dmm.voltage)
sweep.follow_param(station.lockin.X)

# Start sweep
print("Starting 1D sweep...")
sweep.start()
print("Sweep finished.")
```